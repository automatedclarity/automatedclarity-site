<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ACX Matrix — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #0b1220; color: #e6edf6; }
  .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
  .h1 { font-size: 34px; font-weight: 800; letter-spacing: .2px; margin-bottom: 2px; }
  .muted { color: #96a3b7; }
  input, button, select { font: inherit; }
  button { background: #1b69ff; border: none; color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; }
  button:disabled { opacity: .6; cursor: default; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .cards { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; margin: 16px 0 8px; }
  .card { background: #0f1629; border:1px solid #1c2640; border-radius: 14px; padding: 14px; }
  .k { font-size: 12px; color: #9fb0cc; }
  .v { font-size: 22px; font-weight: 800; margin-top: 4px; }
  table { width: 100%; border-collapse: collapse; margin-top: 18px; }
  th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #1c2640; }
  th { color:#9fb0cc; font-weight: 600; }
  .right { text-align: right; }
  .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; display: inline-block; }
  .b-opt { background: #0d2a13; color: #39d353; border: 1px solid #1d4e26; }
  .b-deg { background: #2b1d0d; color: #ffb224; border: 1px solid #4e3a1d; }
  .b-crit{ background: #2a0d0d; color: #ff5f56; border: 1px solid #4e1d1d; }
  .b-unk { background: #1a1f2b; color: #9fb0cc; border: 1px solid #273149; }
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">ACX Matrix — Dashboard</div>
  <div class="muted">Live integrity &amp; performance across locations</div>

  <div class="row" style="margin-top:10px">
    <span class="k">Auto-refresh</span>
    <select id="freq">
      <option value="0">Off</option>
      <option value="5">5s</option>
      <option value="10" selected>10s</option>
      <option value="30">30s</option>
      <option value="60">60s</option>
    </select>

    <span class="k" style="margin-left:16px">Recent rows</span>
    <input id="lim" type="number" min="10" max="100" value="100" style="width:90px;background:#0f1629;border:1px solid #1c2640;color:#e6edf6;border-radius:10px;padding:8px">
    <button id="load">Load</button>
    <div class="muted" id="meta" style="margin-left:8px"></div>
  </div>

  <div class="cards">
    <div class="card"><div class="k">Locations (by severity)</div><div class="v" id="c_locs">–</div></div>
    <div class="card"><div class="k">Critical</div><div class="v" id="c_crit">–</div></div>
    <div class="card"><div class="k">Degraded</div><div class="v" id="c_deg">–</div></div>
    <div class="card"><div class="k">Optimal</div><div class="v" id="c_opt">–</div></div>
  </div>

  <h3 style="margin:14px 0 8px">Locations</h3>
  <div id="locs"></div>

  <h3 style="margin:14px 0 8px">Recent Ingests</h3>
  <table>
    <thead>
      <tr>
        <th>Timestamp</th><th>Account</th><th>Location</th>
        <th class="right">Uptime</th><th class="right">Conv</th><th class="right">Resp (ms)</th>
        <th class="right">Quotes</th><th>Integrity</th><th>Run ID</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
(async () => {
  // Gate: must be logged in
  const ok = await fetch('/.netlify/functions/auth-check', { credentials:'same-origin' })
    .then(r => r.ok)
    .catch(()=>false);
  if (!ok) { location.href = '/login.html'; return; }
})();

const $ = (id) => document.getElementById(id);
const sevClass = (s) => s==='critical'?'b-crit':(s==='degraded'?'b-deg':(s==='optimal'?'b-opt':'b-unk'));

async function load() {
  $("load").disabled = true;
  const limit = +$("lim").value || 100;

  const res = await fetch(`/.netlify/functions/acx-matrix-summary?limit=${limit}`, {
    credentials: 'same-origin'
  });
  $("load").disabled = false;

  if (!res.ok) { alert("Fetch failed"); return; }
  const data = await res.json().catch(()=>({ok:false}));
  if (!data.ok) { alert("Fetch failed"); return; }

  // Counters
  const locs = data.locations || [];
  const crit = locs.filter(l=>l.integrity==='critical').length;
  const deg  = locs.filter(l=>l.integrity==='degraded').length;
  const opt  = locs.filter(l=>l.integrity==='optimal').length;
  $("c_locs").textContent = String(locs.length);
  $("c_crit").textContent = String(crit);
  $("c_deg").textContent  = String(deg);
  $("c_opt").textContent  = String(opt);
  $("meta").textContent   = `${(data.recent||[]).length} recent rows`;

  // Locations (simple list for now)
  const holder = $("locs");
  holder.innerHTML = "";
  locs.forEach(l => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">${l.account}</div>
          <div class="muted" style="font-size:12px">${l.location}</div>
        </div>
        <div><span class="badge ${sevClass(l.integrity)}">${l.integrity}</span></div>
      </div>
    `;
    holder.appendChild(div);
  });

  // Recent table
  const tbody = $("rows");
  tbody.innerHTML = "";
  (data.recent||[]).forEach(r => {
    const tr = document.createElement("tr");
    const dt = r.ts ? new Date(r.ts) : null;
    tr.innerHTML = `
      <td>${dt?dt.toLocaleString():''}</td>
      <td>${r.account||''}</td>
      <td>${r.location||''}</td>
      <td class="right">${r.uptime!==""?Number(r.uptime).toFixed(1):""}</td>
      <td class="right">${r.conversion!==""?Number(r.conversion).toFixed(1):""}</td>
      <td class="right">${r.response_ms!==""?Number(r.response_ms).toFixed(0):""}</td>
      <td class="right">${r.quotes_recovered!==""?Number(r.quotes_recovered).toFixed(0):""}</td>
      <td><span class="badge ${sevClass((r.integrity||'').toLowerCase())}">${(r.integrity||'').toLowerCase()}</span></td>
      <td>${r.run_id||''}</td>
    `;
    tbody.appendChild(tr);
  });
}
$("load").addEventListener("click", load);

// Auto refresh
let t=null; $("freq").addEventListener("change", ()=>{
  if (t) clearInterval(t);
  const s = +$("freq").value;
  if (s>0) t = setInterval(load, s*1000);
});
</script>
</body>
</html>
