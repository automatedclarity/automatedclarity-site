<!-- /public/matrix.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACX Matrix — Dashboard</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #0b1220; color: #e6edf6; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .h1 { font-size: 34px; font-weight: 800; letter-spacing: .2px; margin-bottom: 2px; }
    .muted { color: #96a3b7; }
    input, button, select { font: inherit; }
    input[type="password"], input[type="text"], input[type="number"] {
      background:#0f1629; border:1px solid #1c2640; color:#e6edf6; border-radius:10px; padding:10px 12px;
    }
    button { background:#1b69ff; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    button:disabled { opacity:.6; cursor:default; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .cards { display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px; margin:16px 0 8px; }
    .card { background:#0f1629; border:1px solid #1c2640; border-radius:14px; padding:14px; }
    .k { font-size:12px; color:#9fb0cc; }
    .v { font-size:22px; font-weight:800; margin-top:4px; }
    .grid { display:grid; grid-template-columns:220px 120px 120px 120px 1fr 120px; gap:8px; }
    .locrow { background:#0f1629; border:1px solid #1c2640; border-radius:12px; padding:12px; align-items:center; }
    .badge { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
    .b-opt { background:#0d2a13; color:#39d353; border:1px solid #1d4e26; }
    .b-deg { background:#2b1d0d; color:#ffb224; border:1px solid #4e3a1d; }
    .b-crit{ background:#2a0d0d; color:#ff5f56; border:1px solid #4e1d1d; }
    .b-unk { background:#1a1f2b; color:#9fb0cc; border:1px solid #273149; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #1c2640; }
    th { color:#9fb0cc; font-weight:600; }
    .right { text-align:right; }
    .spark { width:100%; height:42px; }
    .controls { gap:10px; margin-top:10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; background:#0f1629; border:1px solid #1c2640; border-radius:999px; padding:8px 12px; }
    .small { font-size:12px; color:#9fb0cc; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">ACX Matrix — Dashboard</div>
    <div class="muted">Live integrity & performance across locations</div>

    <div class="row controls">
      <span class="pill">
        <span class="small">Secret</span>
        <input id="sec" type="password" placeholder="x-acx-secret" style="min-width:280px">
      </span>
      <span class="pill">
        <span class="small">Auto-refresh</span>
        <select id="freq">
          <option value="0">Off</option>
          <option value="5">5s</option>
          <option value="10" selected>10s</option>
          <option value="30">30s</option>
          <option value="60">60s</option>
        </select>
      </span>
      <span class="pill">
        <span class="small">Recent rows</span>
        <input id="lim" type="number" min="10" max="100" value="100" style="width:90px">
      </span>
      <button id="load">Load</button>
      <div class="muted small" id="meta"></div>
    </div>

    <div class="cards">
      <div class="card"><div class="k">Locations (by severity)</div><div class="v" id="c_locs">—</div></div>
      <div class="card"><div class="k">Critical</div><div class="v" id="c_crit">—</div></div>
      <div class="card"><div class="k">Degraded</div><div class="v" id="c_deg">—</div></div>
      <div class="card"><div class="k">Optimal</div><div class="v" id="c_opt">—</div></div>
    </div>

    <h3 style="margin:14px 0 8px">Locations</h3>
    <div id="locs"></div>

    <h3 style="margin:14px 0 8px">Recent Ingests</h3>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th><th>Account</th><th>Location</th>
          <th class="right">Uptime</th><th class="right">Conv</th><th class="right">Resp (ms)</th>
          <th class="right">Quotes</th><th>Integrity</th><th>Run ID</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const sevClass = (s) => s==='critical'?'b-crit':(s==='degraded'?'b-deg':(s==='optimal'?'b-opt':'b-unk'));

function sparkline(points, min, max, color="#7aa2ff") {
  if (!points.length) return '';
  const w=220, h=42, pad=4, span=w-(pad*2);
  const ys = points.map(v => {
    const cl = (v - min) / Math.max(1e-9, (max - min));
    return h - pad - (cl * (h-pad*2));
  });
  const xs = points.map((_,i)=> pad + (i/(points.length-1))*span);
  let d = `M ${xs[0]} ${ys[0]}`;
  for (let i=1;i<xs.length;i++) d += ` L ${xs[i]} ${ys[i]}`;
  return `<svg class="spark" viewBox="0 0 ${w} ${h}">
    <path d="${d}" fill="none" stroke="${color}" stroke-width="2"/>
  </svg>`;
}

function getSecret() {
  let s = localStorage.getItem('acx_secret') || '';
  if (!s) {
    s = ($("sec")?.value || '').trim();
    if (!s) s = prompt('Enter your x-acx-secret') || '';
  }
  if (s) localStorage.setItem('acx_secret', s);
  if ($("sec") && !$("sec").value) $("sec").value = s;
  return s;
}

async function load() {
  const secret = getSecret();
  if (!secret) { alert("Enter secret"); return; }
  $("load").disabled = true;

  const limit = +$("lim").value || 100;

  // Use the confirmed-good endpoint for now
  const res = await fetch("/.netlify/functions/acx-matrix-recent?limit=" + limit, {
    headers: { "x-acx-secret": secret },
    cache: "no-store"
  });

  let data = { ok:false };
  try { data = await res.json(); } catch {}
  $("load").disabled = false;

  if (!data.ok) { alert("Fetch failed"); return; }

  // Counters (summary cards will light up once we wire the summary API)
  const events = data.events || [];
  $("c_locs").textContent = "—";
  $("c_crit").textContent = "—";
  $("c_deg").textContent  = "—";
  $("c_opt").textContent  = "—";
  $("meta").textContent   = `${events.length} recent rows`;

  // Clear locations grid for now
  $("locs").innerHTML = "";

  // Recent table
  const tbody = $("rows");
  tbody.innerHTML = "";
  events.forEach(r => {
    const tr = document.createElement("tr");
    const dt = r.ts ? new Date(r.ts) : null;
    tr.innerHTML = `
      <td>${dt?dt.toLocaleString():''}</td>
      <td>${r.account||''}</td>
      <td>${r.location||''}</td>
      <td class="right">${r.uptime!==""?Number(r.uptime).toFixed(1):""}</td>
      <td class="right">${r.conversion!==""?Number(r.conversion).toFixed(1):""}</td>
      <td class="right">${r.response_ms!==""?Number(r.response_ms).toFixed(0):""}</td>
      <td class="right">${r.quotes_recovered!==""?Number(r.quotes_recovered).toFixed(0):""}</td>
      <td><span class="badge ${sevClass((r.integrity||'').toLowerCase())}">${(r.integrity||'').toLowerCase()}</span></td>
      <td>${r.run_id||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

$("load").addEventListener("click", load);

// Auto refresh loop
let timer = null;
$("freq").addEventListener("change", () => {
  if (timer) clearInterval(timer);
  const s = +$("freq").value;
  if (s > 0) timer = setInterval(() => {
    if (($("sec").value || localStorage.getItem('acx_secret') || '').trim()) load();
  }, s * 1000);
});

// If a secret is already saved, prefill and auto-load once
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem('acx_secret') || '';
  if (saved && $("sec")) $("sec").value = saved;
  if (saved) load();
});
</script>
</body>
</html>
